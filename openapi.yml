openapi: 3.0.3
info:
  title: Easyapp API
  version: 1.0.0
  description: API documentation for easyapp
security:
  - bearerAuth: []
paths:
  /api/hello/:
    get:
      operationId: api_hello_retrieve
      description: Get a hello world message
      tags:
        - api
      security: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
          description: ''
  /api/auth/register/:
    post:
      operationId: auth_register
      tags:
        - auth
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MemberRegisterIn'
      responses:
        '201':
          description: Member created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberPublic'
        '400':
          description: Validation error
  /api/auth/login/:
    post:
      operationId: auth_login
      tags:
        - auth
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginIn'
      responses:
        '200':
          description: Tokens returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokensOut'
        '401':
          description: Invalid credentials
  /api/auth/refresh/:
    post:
      operationId: auth_refresh
      tags:
        - auth
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh:
                  type: string
              required: [refresh]
      responses:
        '200':
          description: New access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokensOut'
  /api/me/:
    get:
      operationId: me_retrieve
      tags:
        - me
      responses:
        '200':
          description: Current member profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberPublic'
        '401':
          description: Unauthorized
    patch:
      operationId: me_update
      tags:
        - me
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MemberUpdateIn'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberPublic'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
  /api/me/favorites/:
    get:
      operationId: me_favorites
      tags:
        - me
      responses:
        '200':
          description: Favorite ads of current member
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdCard'
        '401':
          description: Unauthorized
  /api/me/ads/:
    get:
      operationId: me_ads
      tags:
        - me
      responses:
        '200':
          description: Ads owned by current member
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdCard'
        '401':
          description: Unauthorized
  /api/me/history/:
    get:
      operationId: me_history
      tags:
        - me
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Last N unique ads viewed by the current member ordered by latest view time (unique by ad)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryList'
        '401':
          description: Unauthorized
  /api/ads/import/:
    post:
      operationId: ads_import
      tags:
        - ads
      security: []
      description: |
        Import ad metadata from a public Avito URL and create an Ad.
        Only publicly available metadata is fetched. If blocked by site protections, no circumvention is performed.
        If a valid JWT is provided, the created Ad will be associated with the current member; otherwise the owner is null.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImportAdIn'
      responses:
        '201':
          description: Created ad from imported metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdDetail'
        '400':
          description: Bad request
        '422':
          description: Unable to fetch metadata (e.g., blocked or missing public data). The client may prompt for manual input.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportError'
  /api/ads/popular/:
    get:
      operationId: ads_popular
      tags:
        - ads
      security: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Popular ads list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/AdCard'
                  next_offset:
                    type: integer
                    nullable: true
                required: [items]
  /api/ads/{id}/:
    get:
      operationId: ad_detail
      tags:
        - ads
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Ad detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdDetail'
        '404':
          description: Not found
  /api/ads/{id}/ratings/:
    post:
      operationId: ad_rate
      tags:
        - ads
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RatingIn'
      responses:
        '200':
          description: Updated ad with new rating stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdDetail'
        '401':
          description: Unauthorized
        '404':
          description: Not found
  /api/ads/{id}/favorite/:
    post:
      operationId: ad_favorite_toggle
      tags:
        - ads
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Favorite toggled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FavoriteOut'
        '401':
          description: Unauthorized
        '404':
          description: Not found
  /api/ads/{id}/views/:
    post:
      operationId: ad_view_create
      tags:
        - ads
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Record a unique view (24h window) and return updated views_count. Auth users unique by (ad, member). Guests approximated by sha256(ip + '|' + user_agent).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ViewOut'
        '404':
          description: Not found
  /api/ads/{id}/comments/:
    get:
      operationId: ad_comments_list
      tags:
        - comments
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: parent
          schema:
            type: integer
            nullable: true
          description: If provided, returns replies for this comment id; otherwise returns top-level comments
      responses:
        '200':
          description: Comments list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Comment'
                  next_offset:
                    type: integer
                    nullable: true
                required: [items]
        '404':
          description: Ad not found
    post:
      operationId: ad_comments_create
      tags:
        - comments
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreateIn'
      responses:
        '201':
          description: Created comment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '404':
          description: Ad or parent not found
  /api/comments/{id}/:
    delete:
      operationId: comment_delete
      tags:
        - comments
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted
        '403':
          description: Forbidden
        '404':
          description: Not found
  /api/comments/{id}/like/:
    post:
      operationId: comment_like_toggle
      tags:
        - comments
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Like toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_liked:
                    type: boolean
                  likes_count:
                    type: integer
                required: [is_liked, likes_count]
        '401':
          description: Unauthorized
        '404':
          description: Not found
  /api/imports/:
    post:
      operationId: imports_create
      tags:
        - imports
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
              required: [url]
      responses:
        '201':
          description: Import job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  url:
                    type: string
                  status:
                    type: string
                    enum: [done, queued, processing, blocked, error]
                  retry_after:
                    type: integer
                    nullable: true
                  message:
                    type: string
                    nullable: true
                  ad_id:
                    type: integer
                    nullable: true
                required: [id, url, status]
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '429':
          description: Rate limited (local or remote)
  /api/imports/{id}/:
    get:
      operationId: imports_retrieve
      tags:
        - imports
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Import job status
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  url:
                    type: string
                  status:
                    type: string
                    enum: [done, queued, processing, blocked, error]
                  retry_after:
                    type: integer
                    nullable: true
                  message:
                    type: string
                    nullable: true
                  ad_id:
                    type: integer
                    nullable: true
                required: [id, url, status]
components:
  schemas:
    Message:
      type: object
      properties:
        message:
          type: string
          maxLength: 200
        timestamp:
          type: string
          format: date-time
          readOnly: true
      required:
        - message
        - timestamp
    MemberPublic:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        avatar_url:
          type: string
        created_at:
          type: string
          format: date-time
      required: [id, username, email, created_at]
    MemberRegisterIn:
      type: object
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
        avatar_url:
          type: string
      required: [username, email, password]
    MemberUpdateIn:
      type: object
      properties:
        username:
          type: string
        avatar_url:
          type: string
    AuthLoginIn:
      type: object
      properties:
        username_or_email:
          type: string
        password:
          type: string
      required: [username_or_email, password]
    AuthTokensOut:
      type: object
      properties:
        access:
          type: string
        refresh:
          type: string
      required: [access, refresh]
    ImportAdIn:
      type: object
      properties:
        url:
          type: string
          format: uri
      required: [url]
    ImportError:
      type: object
      properties:
        code:
          type: string
          description: Structured error code.
          enum: [invalid_url, not_avito, request_failed, blocked, parse_failed, empty]
        detail:
          type: string
        message:
          type: string
        note:
          type: string
      required: [code, detail]
    AdCard:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        price:
          type: integer
          description: Price in minor currency units (cents)
        cover:
          type: string
          nullable: true
          description: First photo URL if available
        views_count:
          type: integer
        comments_count:
          type: integer
        likes_count:
          type: integer
        avg_rating:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
      required: [id, title, price, views_count, comments_count, likes_count, avg_rating, created_at]
    AdDetail:
      allOf:
        - $ref: '#/components/schemas/AdCard'
        - type: object
          properties:
            photos:
              type: array
              items:
                type: string
            description:
              type: string
            source_url:
              type: string
            owner:
              $ref: '#/components/schemas/MemberPublic'
              nullable: true
          required: [photos, description, source_url]
    RatingIn:
      type: object
      properties:
        value:
          type: integer
          minimum: 1
          maximum: 5
      required: [value]
    FavoriteOut:
      type: object
      properties:
        is_favorite:
          type: boolean
      required: [is_favorite]
    Comment:
      type: object
      properties:
        id:
          type: integer
        ad:
          type: integer
        author:
          $ref: '#/components/schemas/MemberPublic'
        parent:
          type: integer
          nullable: true
        text:
          type: string
        likes_count:
          type: integer
        created_at:
          type: string
          format: date-time
        replies_count:
          type: integer
      required: [id, ad, author, text, likes_count, created_at, replies_count]
    CommentCreateIn:
      type: object
      properties:
        text:
          type: string
        parent:
          type: integer
          nullable: true
      required: [text]
    ViewOut:
      type: object
      properties:
        views_count:
          type: integer
      required: [views_count]
    HistoryItem:
      type: object
      properties:
        ad:
          $ref: '#/components/schemas/AdCard'
        viewed_at:
          type: string
          format: date-time
      required: [ad, viewed_at]
    HistoryList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/HistoryItem'
      required: [items]
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
